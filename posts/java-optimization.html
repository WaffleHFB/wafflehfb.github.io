<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java æ€§èƒ½ä¼˜åŒ–å®è·µ - Waffle's Blog</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">
                <a href="../index.html"><code>Waffle</code></a>
            </div>
            <ul class="nav-links">
                <li><a href="../posts.html" class="active">æ–‡ç« </a></li>
                <li><a href="../projects.html">é¡¹ç›®</a></li>
                <li><a href="../changelog.html">æ›´æ–°æ—¥å¿—</a></li>
                <li><a href="../about.html">å…³äº</a></li>
                <li><a href="https://github.com/WaffleHFB" target="_blank" class="github-link">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <main class="container post-detail">
        <article>
            <header class="post-header">
                <div class="post-meta">
                    <time>2024-03-18</time>
                    <span class="tag">Java</span>
                    <span class="tag">æ€§èƒ½ä¼˜åŒ–</span>
                </div>
                <h1>Java æ€§èƒ½ä¼˜åŒ–å®è·µ</h1>
                <div class="post-info">
                    <span>é˜…è¯»æ—¶é—´ï¼š30åˆ†é’Ÿ</span>
                    <span>ä½œè€…ï¼šWaffle</span>
                </div>
            </header>

            <div class="post-content">
                <h2>å¼•è¨€</h2>
                <p>åœ¨é«˜æ€§èƒ½ Java åº”ç”¨å¼€å‘ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæ°¸æ’çš„ä¸»é¢˜ã€‚æœ¬æ–‡å°†ä»å®æˆ˜ç»éªŒå‡ºå‘ï¼Œåˆ†äº«ä¸€äº›è¡Œä¹‹æœ‰æ•ˆçš„ä¼˜åŒ–æŠ€å·§ã€‚</p>

                <h2>JVM è°ƒä¼˜</h2>
                <h3>å†…å­˜åˆ†é…</h3>
                <div class="code-block">
                    <pre><code>
// JVM å‚æ•°ä¼˜åŒ–ç¤ºä¾‹
-Xms4g -Xmx4g // å †å†…å­˜åˆå§‹å€¼å’Œæœ€å¤§å€¼
-XX:+UseG1GC  // ä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨
-XX:MaxGCPauseMillis=200 // æœ€å¤§GCåœé¡¿æ—¶é—´
-XX:ParallelGCThreads=8  // å¹¶è¡ŒGCçº¿ç¨‹æ•°
-XX:ConcGCThreads=2      // å¹¶å‘GCçº¿ç¨‹æ•°
-XX:InitiatingHeapOccupancyPercent=45 // è§¦å‘æ ‡è®°å‘¨æœŸçš„å †å ç”¨ç‡

// å®æˆ˜æ¡ˆä¾‹ï¼šå®¢æˆ·ç«¯å†…å­˜åˆ†é…
public class MemoryConfig {
    static {
        // æ ¹æ®ç³»ç»Ÿå†…å­˜åŠ¨æ€è°ƒæ•´
        long systemMemory = getSystemMemory();
        if (systemMemory > 8_000_000_000L) { // 8GBä»¥ä¸Š
            System.setProperty("java.heap.size", "4g");
        } else {
            System.setProperty("java.heap.size", "2g");
        }
    }
}
                    </code></pre>
                </div>

                <h3>åƒåœ¾å›æ”¶ä¼˜åŒ–</h3>
                <p>é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†å™¨å¯¹æ€§èƒ½å½±å“é‡å¤§ï¼š</p>
                <div class="code-block">
                    <pre><code>
// GCæ—¥å¿—åˆ†æå·¥å…·
public class GCAnalyzer {
    private static final Pattern GC_PATTERN = 
        Pattern.compile("\\[(\\d+\\.\\d+)s\\].*");
    
    public static void analyzeGCLog(String logFile) {
        List<Double> pauseTimes = new ArrayList<>();
        // åˆ†æGCåœé¡¿æ—¶é—´
        Files.lines(Paths.get(logFile))
            .filter(line -> line.contains("[GC"))
            .map(GCAnalyzer::extractPauseTime)
            .forEach(pauseTimes::add);
            
        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        DoubleSummaryStatistics stats = 
            pauseTimes.stream().mapToDouble(d -> d)
                     .summaryStatistics();
        System.out.printf("å¹³å‡åœé¡¿æ—¶é—´: %.2fms\n", 
                         stats.getAverage());
    }
}
                    </code></pre>
                </div>

                <h2>ä»£ç å±‚é¢ä¼˜åŒ–</h2>
                <h3>é›†åˆç±»ä¼˜åŒ–</h3>
                <div class="code-block">
                    <pre><code>
// ä¼˜åŒ–å‰
List<String> list = new ArrayList<>();
for (int i = 0; i < 10000; i++) {
    list.add("item" + i);
}

// ä¼˜åŒ–å
List<String> list = new ArrayList<>(10000);
for (int i = 0; i < 10000; i++) {
    list.add("item" + i);
}

// è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šä½¿ç”¨StringBuilder
StringBuilder sb = new StringBuilder(16 * 10000);
for (int i = 0; i < 10000; i++) {
    sb.append("item").append(i);
}

// è‡ªå®šä¹‰é›†åˆç±»ä¼˜åŒ–
public class FastList<E> extends ArrayList<E> {
    private static final int DEFAULT_WINDOW = 1000;
    private final int windowSize;
    
    public FastList() {
        this(DEFAULT_WINDOW);
    }
    
    public FastList(int windowSize) {
        super(windowSize);
        this.windowSize = windowSize;
    }
    
    @Override
    public boolean add(E e) {
        ensureWindowCapacity();
        return super.add(e);
    }
    
    private void ensureWindowCapacity() {
        if (size() >= capacity()) {
            grow(size() + windowSize);
        }
    }
}
                    </code></pre>
                </div>

                <h3>å¹¶å‘ä¼˜åŒ–</h3>
                <p>åˆç†ä½¿ç”¨çº¿ç¨‹æ± å’Œå¹¶å‘å·¥å…·ï¼š</p>
                <div class="code-block">
                    <pre><code>
// è‡ªå®šä¹‰çº¿ç¨‹æ± 
public class OptimizedThreadPool {
    private final ThreadPoolExecutor executor;
    private final BlockingQueue<Runnable> workQueue;
    
    public OptimizedThreadPool(int coreSize, int maxSize) {
        workQueue = new LinkedBlockingQueue<>(10000);
        executor = new ThreadPoolExecutor(
            coreSize,
            maxSize,
            60L, TimeUnit.SECONDS,
            workQueue,
            new ThreadFactory() {
                private final AtomicInteger counter = 
                    new AtomicInteger(1);
                @Override
                public Thread newThread(Runnable r) {
                    Thread t = new Thread(r);
                    t.setName("Worker-" + counter.getAndIncrement());
                    t.setDaemon(true);
                    return t;
                }
            },
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
    
    public void execute(Runnable task) {
        executor.execute(() -> {
            try {
                task.run();
            } catch (Exception e) {
                handleException(e);
            }
        });
    }
}
                    </code></pre>
                </div>

                <h2>ç¼“å­˜ä¼˜åŒ–</h2>
                <h3>å¤šçº§ç¼“å­˜</h3>
                <div class="code-block">
                    <pre><code>
public class CacheManager<K, V> {
    private final LoadingCache<K, V> firstLevelCache;
    private final Cache<K, V> secondLevelCache;
    
    public CacheManager(CacheLoader<K, V> loader) {
        firstLevelCache = CacheBuilder.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build(loader);
            
        secondLevelCache = CacheBuilder.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(30, TimeUnit.MINUTES)
            .build();
    }
    
    public V get(K key) throws ExecutionException {
        V value = firstLevelCache.getIfPresent(key);
        if (value == null) {
            value = secondLevelCache.getIfPresent(key);
            if (value != null) {
                firstLevelCache.put(key, value);
            }
        }
        return value != null ? value : 
               firstLevelCache.get(key);
    }
}
                    </code></pre>
                </div>

                <h2>å®æˆ˜æ¡ˆä¾‹</h2>
                <h3>æ¸¸æˆå®¢æˆ·ç«¯ä¼˜åŒ–</h3>
                <div class="code-block">
                    <pre><code>
// æ¸²æŸ“ä¼˜åŒ–
public class RenderOptimizer {
    private static final int BATCH_SIZE = 1000;
    private final Queue<RenderTask> taskQueue;
    private final ExecutorService renderThread;
    
    public void submitRenderTask(RenderTask task) {
        if (taskQueue.size() >= BATCH_SIZE) {
            processBatch();
        }
        taskQueue.offer(task);
    }
    
    private void processBatch() {
        List<RenderTask> batch = new ArrayList<>(BATCH_SIZE);
        taskQueue.drainTo(batch, BATCH_SIZE);
        
        // æ‰¹é‡å¤„ç†æ¸²æŸ“ä»»åŠ¡
        renderThread.execute(() -> {
            batch.sort(RenderTask.COMPARATOR);
            for (RenderTask task : batch) {
                task.render();
            }
        });
    }
}
                    </code></pre>
                </div>

                <h2>æ€§èƒ½ç›‘æ§</h2>
                <h3>ç›‘æ§æŒ‡æ ‡</h3>
                <ul>
                    <li>CPU ä½¿ç”¨ç‡</li>
                    <li>å†…å­˜å ç”¨</li>
                    <li>GC é¢‘ç‡å’Œæ—¶é—´</li>
                    <li>çº¿ç¨‹çŠ¶æ€</li>
                    <li>å“åº”æ—¶é—´</li>
                </ul>

                <div class="code-block">
                    <pre><code>
public class PerformanceMonitor {
    private static final ScheduledExecutorService scheduler = 
        Executors.newScheduledThreadPool(1);
        
    public static void startMonitoring() {
        scheduler.scheduleAtFixedRate(() -> {
            // æ”¶é›†æ€§èƒ½æŒ‡æ ‡
            MemoryMXBean memoryBean = 
                ManagementFactory.getMemoryMXBean();
            MemoryUsage heapUsage = 
                memoryBean.getHeapMemoryUsage();
            
            // è®°å½•åˆ°æ—¥å¿—
            log.info("Heap used: {}MB, Max: {}MB", 
                    heapUsage.getUsed() / 1024 / 1024,
                    heapUsage.getMax() / 1024 / 1024);
        }, 0, 1, TimeUnit.MINUTES);
    }
}
                    </code></pre>
                </div>

                <h2>æœ€ä½³å®è·µ</h2>
                <ul>
                    <li>å…ˆç›‘æ§ï¼Œåä¼˜åŒ–</li>
                    <li>æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆ</li>
                    <li>ä¼˜åŒ–æœ€è€—æ—¶çš„éƒ¨åˆ†</li>
                    <li>ä¿æŒä»£ç å¯ç»´æŠ¤æ€§</li>
                    <li>åšå¥½æ€§èƒ½æµ‹è¯•</li>
                </ul>

                <div class="warning-block">
                    <p>æ³¨æ„ï¼šè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚è¦åœ¨å®é™…æ€§èƒ½é—®é¢˜å‡ºç°æ—¶å†è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–ã€‚</p>
                </div>

                <h2>æ€»ç»“</h2>
                <p>æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨å®è·µä¸­ä¸æ–­ç§¯ç´¯ç»éªŒã€‚æœ¬æ–‡ä»‹ç»çš„è¿™äº›æŠ€å·§éƒ½æ¥è‡ªå®é™…é¡¹ç›®ï¼Œå¸Œæœ›èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</p>
            </div>

            <footer class="post-footer">
                <div class="post-tags">
                    <span class="tag">Java</span>
                    <span class="tag">æ€§èƒ½ä¼˜åŒ–</span>
                    <span class="tag">JVM</span>
                </div>
                <div class="post-nav">
                    <a href="minecraft-client-dev.html" class="post-nav-next">
                        ä¸‹ä¸€ç¯‡ï¼šMinecraft å®¢æˆ·ç«¯å¼€å‘å…¥é—¨æŒ‡å— â†’
                    </a>
                </div>
            </footer>
        </article>
    </main>

    <footer>
        <div class="container">
            <p>Â© 2024 Waffle's Blog. Built with ğŸ’» and ğŸ®</p>
        </div>
    </footer>
    <script src="../particles.js"></script>
    <script src="../matrix-rain.js"></script>
</body>
</html> 